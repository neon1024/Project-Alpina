/*
 MIT license
 @link http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/21963136#21963136
*/
define.nextId("postal.reqres");
(function(e,c){"function"===typeof define&&define.amd?define(["lodash","postal"],function(h,k){return c(h,k,e)}):"object"===typeof module&&module.exports?module.exports=function(e){return c(require("lodash"),e,this)}:e.postal=c(e._,e.postal,e)})(this,function(e,c,h,k){c.configuration.promise={createDeferred:function(){throw Error("You need to provide an implementation for postal.configuration.promise.createDeferred that returns a deferred/promise instance.");},getPromise:function(){throw Error("You need to provide an implementation for postal.configuration.promise.getPromise that returns a promise safe for consuming APIs to use.");},
fulfill:"resolve",fail:"reject"};var n=function(){for(var c={},a=[],b=0;256>b;b++)a[b]=(16>b?"0":"")+b.toString(16);c.create=function(){var c=4294967295*Math.random()|0,b=4294967295*Math.random()|0,d=4294967295*Math.random()|0,g=4294967295*Math.random()|0;return a[c&255]+a[c>>8&255]+a[c>>16&255]+a[c>>24&255]+"-"+a[b&255]+a[b>>8&255]+"-"+a[b>>16&15|64]+a[b>>24&255]+"-"+a[d&63|128]+a[d>>8&255]+"-"+a[d>>16&255]+a[d>>24&255]+a[g&255]+a[g>>8&255]+a[g>>16&255]+a[g>>24&255]};return c}();c.ChannelDefinition.prototype.request=
function(d){var a=d.envelope?d.envelope:{topic:d.topic,data:d.data,headers:d.headers},b=n.create(),l=d.replyTopic||b,m=d.replyChannel||"postal.request-response",f=c.configuration.promise.createDeferred();a.headers=a.headers||{};a.headers.replyable=!0;a.headers.requestId=b;a.headers.replyTopic=l;a.headers.replyChannel=m;c.subscribe({channel:m,topic:l,callback:function(a,b){if(b.headers&&b.headers.isError)a instanceof Error||!a.message||!a.stack||(b=Error(),e.extend(b,a),a=b),f[c.configuration.promise.fail](a);
else f[c.configuration.promise.fulfill](a)}}).once();d.timeout&&setTimeout(function(){f[c.configuration.promise.fail](Error("Timeout limit exceeded for request."))},d.timeout);this.publish(a);return c.configuration.promise.getPromise(f)};var p=c.SubscriptionDefinition.prototype.invokeSubscriber;c.SubscriptionDefinition.prototype.invokeSubscriber=function(d,a){a.headers&&a.headers.replyable&&(a.reply=function(b,d){b&&b instanceof Error&&(b=e.chain(Object.getOwnPropertyNames(b)).map(function(a){return[a,
b[a]]}).object().value());c.publish({channel:a.headers.replyChannel,topic:a.headers.replyTopic,headers:{isReply:!0,isError:!!b,requestId:a.headers.requestId,resolverNoCache:!0},data:b||d})});p.call(this,d,a)};return c});