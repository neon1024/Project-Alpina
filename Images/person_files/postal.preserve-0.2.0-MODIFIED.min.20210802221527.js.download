define.nextId("postal.preserve");
(function(d,e){"function"===typeof define&&define.amd?define(["lodash","conduitjs","postal"],function(a,h,k){return e(a,h,k,d)}):"object"===typeof module&&module.exports?module.exports=function(a){e(require("lodash"),require("conduitjs"),a,this)}:d.postal=e(d._,d.Conduit,d.postal,d)})(this,function(d,e,a,h,k){function l(){for(var a=new Date,b=d.filter(c.expiring,function(b){return b.expires<a});b.length;)b.pop().purge()}var c=a.preserve={store:{},expiring:[]};a.channel(a.configuration.SYSTEM_CHANNEL);var m=
function(a,b){return b.expires-a.expires};a.addWireTap(function(a,b){var f=b.channel,g=b.topic;b.headers&&(b.headers.preserve||b.headers.preserveOne)&&(c.store[f]=c.store[f]||{},c.store[f][g]=c.store[f][g]||[],b.headers.preserveOne?c.store[f][g]=[b]:c.store[f][g].push(b),b.headers.expires&&(c.expiring.push({expires:b.headers.expires,purge:function(){c.store[f][g]=d.without(c.store[f][g],b);c.expiring=d.without(c.expiring,this)}}),c.expiring.sort(m)))});a.subscribe.after||(a.subscribe=new e.Sync({context:a,
target:a.subscribe}));a.SubscriptionDefinition.prototype.enlistPreserved=function(){var e=this.channel,b=this.topic,f=this;l(!0);c.store[e]&&d.each(c.store[e],function(c,e){a.configuration.resolver.compare(b,e)&&d.each(c,function(a){f.invokeSubscriber(a.data,a)})});return this};return a});